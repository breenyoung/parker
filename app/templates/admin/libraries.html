{% extends "base.html" %}

{% block title %}Library Management - Parker{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto" x-data="libraryManager()">

    {% from "partials/admin_header.html" import admin_header %}
    {{ admin_header(
        title="Libraries",
        description="Manage your comic libraries.",
        action_label="+ Add Library",
            action_func="openAddModal()"
    ) }}

    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg border border-gray-700">
        <table class="w-full text-left">
            <thead class="bg-gray-900 text-gray-400 uppercase text-xs">
                <tr>
                    <th class="px-6 py-3">Name</th>
                    <th class="px-6 py-3">Path</th>
                    <th class="px-6 py-3">Status</th>
                    <th class="px-6 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                <template x-for="lib in libraries" :key="lib.id">
                    <tr class="hover:bg-gray-750">
                        <td class="px-6 py-4 font-bold text-white">
                            <a :href="window.parker.route('pages.library_detail', { library_id: lib.id })" class="hover:text-blue-400 transition-colors" x-text="lib.name"></a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400 font-mono" x-text="lib.path"></td>
                        <td class="px-6 py-4 text-sm text-gray-400">
                            <div x-show="lib.is_scanning" class="flex items-center text-blue-400 text-xs font-bold animate-pulse">
                                <span class="mr-2">â†»</span> Working...
                            </div>
                            <div x-show="!lib.is_scanning" x-text="formatDate(lib.last_scanned)"></div>
                        </td>
                        <td class="px-6 py-4 text-right flex justify-end items-center gap-2">
                            <button
                                x-on:click="triggerScan(lib, false)"
                                class="bg-gray-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="lib.is_scanning"
                            >
                                <span x-text="lib.is_scanning ? 'Busy' : 'Scan'"></span>
                            </button>

                            <button
                                x-on:click="triggerScan(lib, true)"
                                class="text-gray-500 hover:text-green-400 text-xs px-2 disabled:opacity-30 disabled:cursor-not-allowed"
                                title="Force Rescan (Ignore timestamps)"
                                :disabled="lib.is_scanning"
                            >
                                Force
                            </button>

                            <div class="h-4 w-px bg-gray-700 mx-1"></div>

                            <button x-on:click="openEditModal(lib)" class="text-blue-400 hover:text-white text-sm font-medium px-2">Edit</button>
                            <button x-on:click="deleteLibrary(lib)" class="text-red-400 hover:text-white text-sm font-medium px-2">Delete</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="libraries.length === 0">
                    <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        No libraries found. Add one to get started.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div x-show="showModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" style="display: none;" x-transition.opacity>
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md border border-gray-700 shadow-2xl" x-on:click.away="showModal = false">
            <h2 class="text-xl font-bold mb-4" x-text="isEditing ? 'Edit Library' : 'Add New Library'"></h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Name</label>
                    <input type="text" x-model="form.name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white focus:border-blue-500 outline-none" placeholder="e.g. DC Comics">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Folder Path</label>
                    <input type="text" x-model="form.path" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white focus:border-blue-500 outline-none" placeholder="/comics/dc">
                    <p class="text-xs text-gray-500 mt-1">Server-side path where files are located.</p>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input
                            type="checkbox"
                            x-model="form.watch_mode"
                            class="rounded bg-gray-900 border-gray-700 text-blue-600 focus:ring-blue-500 w-5 h-5"
                        >
                        <div>
                            <span class="block text-sm text-gray-300">Watch Folder</span>
                            <span class="block text-xs text-gray-500">Automatically scan when files are added or changed.</span>
                        </div>
                    </label>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button x-on:click="showModal = false" class="text-gray-400 hover:text-white px-4 py-2 transition-colors">Cancel</button>
                    <button x-on:click="saveLibrary()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors shadow-lg">
                        <span x-text="isEditing ? 'Save Changes' : 'Create Library'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
function libraryManager() {
    return {
        libraries: [],
        showModal: false,
        isEditing: false,
        form: { id: null, name: '', path: '', watch_mode: false },
        pollInterval: null,

        init() {
            this.loadLibraries();
            // Start Polling loop to check for scan completion
            this.pollInterval = setInterval(() => {
                this.loadLibraries();
            }, 3000); // Check every 3 seconds
        },

        // Cleanup if page unloads (optional in Alpine usage, but good practice)
        destroy() {
            if (this.pollInterval) clearInterval(this.pollInterval);
        },

        async loadLibraries() {
            try {
                const res = await fetch(window.parker.route('libraries.list'));
                if (res.ok) this.libraries = await res.json();
            } catch(e) { console.error(e); }
        },

        openAddModal() {
            this.isEditing = false;
            this.form = { id: null, name: '', path: '' };
            this.showModal = true;
        },

        openEditModal(lib) {
            this.isEditing = true;
            this.form = { id: lib.id, name: lib.name, path: lib.path, watch_mode: lib.watch_mode };
            this.showModal = true;
        },

        async saveLibrary() {
            const method = this.isEditing ? 'PATCH' : 'POST';
            const url = this.isEditing ? window.parker.route('libraries.update', { library_id: this.form.id })
                : window.parker.route('libraries.create');

            const payload = {
                name: this.form.name,
                path: this.form.path,
                watch_mode: this.form.watch_mode,
            };

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    this.showModal = false;
                    this.loadLibraries();
                    this.form = { id: null, name: '', path: '' };
                    window.parker.showToast("Library saved", 'success');
                } else {
                    const err = await res.json();
                    await window.parker.dialog.alert('Error', (err.detail || 'Operation Failed'));
                }
            } catch (e) {
                console.error(e);
                await window.parker.dialog.alert('Error', 'Network error occurred');
            }
        },

        async deleteLibrary(lib) {

            const confirmed = await window.parker.dialog.confirm(
                `Delete Library ${lib.name}?`,
                'This removes all comics from the database (files remain intact).',
                { isDestructive: true, confirmText: 'Remove' }
            );

            if (confirmed) {
                try {
                    const res = await fetch(window.parker.route('libraries.delete',
                        { library_id: lib.id }), { method: 'DELETE' }
                    );

                    if(res.ok) {
                        this.loadLibraries();
                        window.parker.showToast("Library deleted", "success");
                    }
                } catch(e) {
                    console.error(e);
                    await window.parker.dialog.alert('Error', 'Failed to delete library');
                }
            }
        },

        async triggerScan(lib, force) {
            const confirmMsg = force
                ? `Force full re-scan of "${lib.name}"? This may take a while.`
                : `Scan "${lib.name}" for new / updated files?`;

            const confirmed = await window.parker.dialog.confirm(
                `Scan Library`,
                confirmMsg,
                { isDestructive: false, confirmText: 'Scan' }
            );

            if (!confirmed) return;

            lib.is_scanning = true; // Optimistic update

            const res = await fetch(window.parker.route('libraries.scan', { library_id: lib.id }, `force=${force}`), { method: 'POST' });
            if (res.ok) {
                // We rely on the pollInterval to update the status from here
                window.parker.showToast("Scan started", 'info');
            } else {
                lib.is_scanning = false;
                await window.parker.dialog.alert('Error', 'Failed to start scan');
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return 'Never';
            return new Date(dateStr).toLocaleString();
        }
    }
}
</script>
{% endblock %}